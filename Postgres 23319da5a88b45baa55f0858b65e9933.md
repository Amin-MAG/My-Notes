# Postgres

## Tables

To show all of the tables in the database you can use `\dt` or `\dt+`.

## Switch between databases

To show all of the databases you can use `\l` or `\l+`.

For switching, you can establish a new connection using `\c gisdb`. This will create a new connection to `gisdb` database.

## Simple queries

```sql
# To get data from nodes table 
select * from nodes;

# To get 100 rows from nodes table
select * from nodes limit 100;

# To count the rows in the table with specefic condition
select count(*) from nodes where nodes.version=2;

# Some other queries
select * from nodes where nodes.version=1 limit 10;
select * from nodes where nodes.version=1 and nodes.id > 30000 limit 10;
select * from nodes where (nodes.version=1 and nodes.id > 30000) or nodes.version=13;
```

## `Pg_dump`

Extract a PostgreSQL database into a script file or other archive file.

```bash
pg_dump --username=<YOUR_USERNAME> dbname > outfile
```

You can also store the database:

```bash
psql --set ON_ERROR_STOP=on dbname < infile
```

## Truncate

It will delete the content of table to set of tables.

```sql
TRUNCATE bigtable, fattable;
```

# Using PostGIS With OSM

To count and find nodes that have a specific tag.

```sql
select * from nodes where nodes.tags->'amenity' = 'bank' limit 50;
select count(*) from nodes where nodes.tags->'amenity' = 'bank';
```

To select all Saman banks:

```sql
select *
from nodes
where nodes.tags -> 'amenity' = 'bank'
	and (
		nodes.tags -> 'name' like '%saman%' or
		nodes.tags-> 'name' like '%Saman%' or
		nodes.tags -> 'name' like '%سامان%'
	)
limit 50;
```

## Functions

`st_y()` and `st_x()` gets the geometry object and will return a double. (latitude or longitude)

## Run sql files from remote

```bash
#!/bin/bash
PGPASSWORD=$POSTGRES_PASSWORD psql -h osm_db -U $POSTGRES_USER -d $POSTGRES_DB -a -f scripts/pgsnapshot_schema_0.6.sql
PGPASSWORD=$POSTGRES_PASSWORD psql -h osm_db -U $POSTGRES_USER -d $POSTGRES_DB -a -f scripts/pgsnapshot_schema_0.6_action.sql
PGPASSWORD=$POSTGRES_PASSWORD psql -h osm_db -U $POSTGRES_USER -d $POSTGRES_DB -a -f scripts/pgsnapshot_schema_0.6_bbox.sql
PGPASSWORD=$POSTGRES_PASSWORD psql -h osm_db -U $POSTGRES_USER -d $POSTGRES_DB -a -f scripts/pgsnapshot_schema_0.6_linestring.sql
```

# Arrays

Arrays start from 1 in Postgre. Using `Array` you can define a new array.

```sql
select Array [st_y(n.geom), st_x(n.geom)] as coordinates from nodes;
```

You can get the value using `[x]` sign.

# Joins

Here I join the tables using `inner join` and by aliasing the `relation_members` as `rm`. Then, I select some columns from the joined tables. 

```sql
select relations.id,
       relations.tags,
       rm.member_id
from relations
         inner join relation_members rm on relations.id = rm.relation_id
limit 20;
```

We have other kinds of joins too:

![Untitled](Postgres%2023319da5a88b45baa55f0858b65e9933/Untitled.png)

## Joining more that one table

```sql
select Array [st_y(n.geom), st_x(n.geom)] as coordinates
from relations
         inner join relation_members rm on relations.id = rm.relation_id
         inner join ways w on rm.member_id = w.id
         inner join nodes n on w.nodes[1] = n.id
where relations.id = 8321779;
```

## Pagination

If you want to have pagination you can use `OFFSET` and `LIMIT`. `OFFSET` is going to skip `n` rows and fetch the data. `LIMIT` also specifies the number of rows that should be fetched.

```sql
select * from users order by users.username offset 4 limit 6;
```

# PostGIS Extension

```sql
select *, st_y(n.geom) as coor_y, st_x(n.geom) as coor_x
from nodes n
where n.id = 467789995;
```

# Hstore Extension

You can use `->` to get the value of a key. For example:

```sql
select count(*) from nodes where nodes.tags->'amenity' = 'bank';
```

To add a new key-value item:

```sql
UPDATE books SET attributes = attributes || 'includes=>"maps, plates, and pictures"' WHERE id = 9;
```

# Miscellaneous

## **Enable `pg_stat_statements` in your Postgres container configuration**

To get query statistics in Postgres, we need to modify the Postgres config setting called `shared_preload_libraries`.

You can do this by stopping your Postgres container, and then starting it again with the correct configuration as [part of the command line arguments](https://docs.docker.com/samples/library/postgres/#database-configuration):

```bash
docker run -d --name my-pg postgres -c "shared_preload_libraries='pg_stat_statements'"
```

### **Verify that `pg_stat_statements` returns data**

As a superuser, run the following statements:

```sql
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
SELECT calls, query FROM pg_stat_statements LIMIT 1;
```

If you have configured your database correctly, this will return a result like this:

```sql
 calls | query
-------+-------
     8 | SELECT * FROM t WHERE field = ?
(1 row)
```